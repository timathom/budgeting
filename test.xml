<?xml version="1.0" encoding="UTF-8"?>
<group
  id="suite"
  ref="instance('test-suite')"
  xmlns="http://www.w3.org/2002/xforms"
  xmlns:ev="http://www.w3.org/2001/xml-events">
  <label>Suite</label>
  <!-- Scenarios -->
  <repeat
    id="scenario-repeat"
    ref="scenarios/scenario">
    <var
      name="s"
      value="count(. | preceding-sibling::scenario)"/>
    <group>
      <label>
        <output
          value="concat($s, '. ', @label)"/>
      </label>
      <repeat
        id="test-repeat"
        ref="test">
        <var
          name="t"
          value="count(. | preceding-sibling::test)"/>
        <group
          ref=".">
          <label>
            <output
              value="concat($s, '.', $t, ' ', @label)"/>
          </label>
          <!-- Result -->
          <group
            id="suite-results">
            <output
              value="choose(@passed[normalize-space(.)] = true(), 'passed', 'failed')"/>
          </group>
        </group>
      </repeat>
    </group>
  </repeat>
  <!-- Test runner -->
  <group
    id="test-runner"
    ref="instance('test-suite')/scenarios">
    <action
      ev:event="run-test"
      iterate="scenario/test">
      <!-- Test 1.1 -->
      <setvalue
        ref="result[../@name = 'login-form-displayed']"
        value="assertDisplayed('user-login')"/>
      <!-- Test 1.2 -->
      <setvalue
        ref="result[../@name = 'rest-of-form-hidden']"
        value="assertDisplayed('hide-login')"/>
      <!-- Test 2.1 -->
      <action
        if="@name = 'login-form-enabled'">
        <delete
          at="1"
          ref="instance('login')/login/user"/>
        <insert
          at="1"
          context="instance('login')/login"
          origin="instance('test-suite')/mocks/mock[@instance = 'login']/user"
          position="before"
          ref="*"/>
        <!-- Only a submit action seems to update the input value in the view -->
        <send
          submission="refresh"/>
        <setvalue
          ref="result"
          value="getInputValue('user-login')"/>
      </action>
      <!-- Test -->
      
      <setvalue
        ref="@passed"
        value="../result = ../expected"/>
    </action>
  </group>
</group>
